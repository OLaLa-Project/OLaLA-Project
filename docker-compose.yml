services:
  # ==========================================================================
  # API Server (FastAPI)
  # ==========================================================================
  api:
    build: ./backend
    ports:
      - "8000:8000"
    env_file:
      - ./.env
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/olala
    depends_on:
      - db

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  db:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: olala
    ports:
      - "5432:5432"
    volumes:
      - olala_pg:/var/lib/postgresql/data

  # ==========================================================================
  # Ollama (선택) — 호스트 Ollama 대신 컨테이너로 띄우고 싶을 때만 사용
  #   docker compose --profile ollama up -d
  # ==========================================================================
  ollama:
    image: ollama/ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    profiles:
      - ollama

  # ==========================================================================
  # SLM2 Test Runner (Stage 6-8)
  # 호스트 Ollama → host.docker.internal:11434 로 연결
  #
  # 사용법:
  #   docker compose --profile test run --rm slm2-test
  #   docker compose --profile test run --rm -e CASE=2 slm2-test
  #   docker compose --profile test run --rm -e ALL=1 slm2-test
  # ==========================================================================
  slm2-test:
    image: python:3.11-slim
    volumes:
      - ./backend:/work
    working_dir: /work
    env_file:
      - ./.env
    environment:
      - PYTHONPATH=/work
    entrypoint: ["sh", "-lc"]
    command:
      - |
        pip install -q -r requirements.txt &&
        if [ "$${ALL:-0}" = "1" ]; then
          python -m tests.demo_slm2_pipeline --all;
        elif [ -n "$${CASE:-}" ]; then
          python -m tests.demo_slm2_pipeline --case "$${CASE}";
        else
          python -m tests.demo_slm2_pipeline --case 1;
        fi
    profiles:
      - test

volumes:
  olala_pg:
  ollama_data:
