services:
  wiki-db:
    image: pgvector/pgvector:pg17
    container_name: olala-wiki-db
    restart: unless-stopped
    env_file:
      - ../../.env.beta
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-olala}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - wiki-db-data:/var/lib/postgresql/data
      - ../../data/wiki_db_dump_file:/import:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-olala}"]
      interval: 10s
      timeout: 5s
      retries: 10

  ollama:
    image: ollama/ollama:latest
    container_name: olala-ollama
    restart: unless-stopped
    profiles: ["llm"]
    gpus: all
    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama

  backend:
    build:
      context: ../../services/backend
    container_name: olala-backend
    restart: unless-stopped
    env_file:
      - ../../.env.beta
    # 중요: backend 런타임 설정은 .env.beta를 단일 source of truth로 사용한다.
    # compose environment 기본값은 env_file 값을 덮어쓰므로 의도치 않은 설정 불일치를 유발한다.
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    depends_on:
      wiki-db:
        condition: service_healthy

networks:
  default:
    name: olala-beta-net

volumes:
  wiki-db-data:
  ollama-data:
